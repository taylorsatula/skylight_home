<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, initial-scale=0.67, maximum-scale=0.67, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <title>Skylight Home</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      margin: 0;
      padding: 0 !important;
      width: 1920px;
      height: 1080px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dashboard {
      width: 1720px;
      height: 880px;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .tile-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, 200px);
      gap: var(--spacing-md);
      width: 100%;
    }

    .content-row {
      display: grid;
      grid-template-columns: 340px 400px 280px 1fr;
      gap: var(--spacing-lg);
      height: 533px;
    }

    .content-row .widget {
      height: 100%;
      overflow: hidden;
    }

    .stacked-widgets {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      height: 100%;
    }

    .stacked-widgets > * {
      flex: 1;
      min-height: 0;
    }

    .stacked-widgets .photo-frame {
      flex: 1.2;
    }

    .stacked-widgets .widget {
      flex: 0.8;
    }

    .bottom-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: var(--spacing-lg);
      flex: 1;
      min-height: 0;
    }

    .radar-frame {
      border-radius: var(--radius-2xl);
      overflow: hidden;
      background: #000;
    }

    .radar-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .radar-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .tile-stack {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      height: 100%;
    }

    .tile-stack .tile {
      flex: 1;
      min-height: 0;
    }

    .house-header {
      position: fixed;
      top: 40px;
      left: 100px;
      z-index: 10;
      display: flex;
      align-items: baseline;
    }

    .house-header__date {
      color: var(--text-secondary);
    }
  </style>
</head>
<body>

  <!-- SVG SYMBOLS -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <defs>
      <symbol id="icon-lightbulb" viewBox="0 0 24 24">
        <path d="M12 2a7 7 0 0 0-7 7c0 2.54 1.4 4.75 3.47 5.9.17.1.28.27.33.46L9 17a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2l.2-1.64c.05-.19.16-.36.33-.46A7 7 0 0 0 12 2z" fill="currentColor"/>
        <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </symbol>
      <symbol id="icon-fan" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="2" fill="currentColor"/>
        <path d="M12 2c-1.5 0-3 1.5-3 4 0 1.5.5 3 3 4M12 2c1.5 0 3 1.5 3 4 0 1.5-.5 3-3 4M2 12c0-1.5 1.5-3 4-3 1.5 0 3 .5 4 3M2 12c0 1.5 1.5 3 4 3 1.5 0 3-.5 4-3M22 12c0-1.5-1.5-3-4-3-1.5 0-3 .5-4 3M22 12c0 1.5-1.5 3-4 3-1.5 0-3-.5-4-3M12 22c-1.5 0-3-1.5-3-4 0-1.5.5-3 3-4M12 22c1.5 0 3-1.5 3-4 0-1.5-.5-3-3-4" fill="currentColor"/>
      </symbol>
      <symbol id="icon-lock" viewBox="0 0 24 24">
        <rect x="5" y="11" width="14" height="10" rx="2" fill="currentColor"/>
        <path d="M8 11V7a4 4 0 1 1 8 0v4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </symbol>
      <symbol id="icon-tv" viewBox="0 0 24 24">
        <rect x="2" y="5" width="20" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="1.8"/>
        <path d="M8 21h8M12 19v2" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </symbol>
      <symbol id="icon-homepod" viewBox="0 0 24 24">
        <ellipse cx="12" cy="19" rx="6" ry="2" fill="currentColor" opacity="0.3"/>
        <path d="M7 18V8a5 5 0 0 1 10 0v10c0 1.1-2.24 2-5 2s-5-.9-5-2z" fill="currentColor"/>
      </symbol>
      <symbol id="icon-star" viewBox="0 0 24 24">
        <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" fill="currentColor"/>
      </symbol>
      <symbol id="icon-users" viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="9" cy="7" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </symbol>
      <symbol id="icon-clock" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.5"/>
        <polyline points="12 6 12 12 16 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </symbol>
      <symbol id="icon-edit" viewBox="0 0 24 24">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" fill="none" stroke="currentColor" stroke-width="1.5"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" fill="none" stroke="currentColor" stroke-width="1.5"/>
      </symbol>
      <symbol id="icon-alert" viewBox="0 0 24 24">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="none" stroke="currentColor" stroke-width="2"/>
        <line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="17" r="1" fill="currentColor"/>
      </symbol>
      <symbol id="icon-chevron" viewBox="0 0 24 24">
        <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </symbol>
      <symbol id="icon-photo" viewBox="0 0 24 24">
        <rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
        <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
        <path d="M21 15l-5-5L5 21" fill="none" stroke="currentColor" stroke-width="1.5"/>
      </symbol>
      <!-- Weather Icons -->
      <symbol id="weather-sun" viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="12" fill="#ffd60a"/>
        <g stroke="#ffd60a" stroke-width="3" stroke-linecap="round">
          <line x1="32" y1="8" x2="32" y2="14"/><line x1="32" y1="50" x2="32" y2="56"/>
          <line x1="8" y1="32" x2="14" y2="32"/><line x1="50" y1="32" x2="56" y2="32"/>
          <line x1="15" y1="15" x2="19.2" y2="19.2"/><line x1="44.8" y1="44.8" x2="49" y2="49"/>
          <line x1="15" y1="49" x2="19.2" y2="44.8"/><line x1="44.8" y1="19.2" x2="49" y2="15"/>
        </g>
      </symbol>
      <symbol id="weather-partly-cloudy" viewBox="0 0 64 64">
        <circle cx="22" cy="24" r="10" fill="#ffd60a"/>
        <g stroke="#ffd60a" stroke-width="2.5" stroke-linecap="round">
          <line x1="22" y1="6" x2="22" y2="10"/><line x1="6" y1="24" x2="10" y2="24"/>
          <line x1="10" y1="12" x2="13" y2="15"/><line x1="10" y1="36" x2="13" y2="33"/>
        </g>
        <path d="M52 44c4.4 0 8-3.6 8-8s-3.6-8-8-8c-.5 0-1 0-1.5.1C49.3 22.5 44.1 18 38 18c-7.7 0-14 6.3-14 14 0 .3 0 .7.1 1C19.2 33.5 16 37 16 41c0 4.4 3.6 8 8 8h28z" fill="#e5e5ea"/>
      </symbol>
      <symbol id="weather-storm" viewBox="0 0 64 64">
        <path d="M48 32c4.4 0 8-3.6 8-8s-3.6-8-8-8c-.5 0-1 0-1.5.1C45.3 10.5 40.1 6 34 6c-7.7 0-14 6.3-14 14 0 .3 0 .7.1 1C15.2 21.5 12 25 12 29c0 4.4 3.6 8 8 8h28z" fill="#6b7280"/>
        <polygon points="36,34 28,48 34,48 30,60 44,44 38,44 42,34" fill="#ffd60a"/>
        <g stroke="#5ac8fa" stroke-width="2" stroke-linecap="round" opacity="0.7">
          <line x1="20" y1="42" x2="18" y2="50"/><line x1="48" y1="40" x2="46" y2="48"/>
        </g>
      </symbol>
    </defs>
  </svg>

  <div class="house-header">
    <h1 class="text-xl" id="homeTitle">Our House and We Live Here</h1>
    <span class="text-xl" style="color: var(--icon-bg-on); padding: 0 20px; position: relative; top: -3px;">|</span>
    <span class="text-xl house-header__date" id="currentDate"></span>
  </div>

  <div class="dashboard">
    <!-- Top row: Device tiles (dynamically generated from DEVICES config) -->
    <div class="tile-row" id="device-tiles"></div>

    <!-- Content row: Calendar, Weather, Photo+Note stack, Shipping -->
    <div class="content-row">
      <!-- Calendar List Widget -->
      <div class="widget">
        <div class="event-list__section">
          <div class="event-list__date">Saturday, Dec 14</div>
          <div class="event-list__items">
            <div class="event-item">
              <div class="event-item__bar"></div>
              <div class="event-item__content"><div class="event-item__title">Rosa quoting Home Cleaning</div></div>
              <div class="event-item__time">
                <span class="event-item__time-start">10:00AM</span>
                <span class="event-item__time-end">11:00AM</span>
              </div>
            </div>
            <div class="event-item">
              <div class="event-item__bar"></div>
              <div class="event-item__content"><div class="event-item__title">Galaxy of Lights</div></div>
              <div class="event-item__time">
                <span class="event-item__time-start">6:00PM</span>
                <span class="event-item__time-end">7:00PM</span>
              </div>
            </div>
          </div>
        </div>
        <div class="event-list__section">
          <div class="event-list__date event-list__date--future">Monday, Dec 16</div>
          <div class="event-list__items">
            <div class="event-item event-item--holiday">
              <div class="event-item__bar event-item__bar--holiday"></div>
              <div class="event-item__content">
                <div class="event-item__title"><svg class="icon icon--sm icon--filled" style="color: var(--color-alert); vertical-align: middle; margin-right: 4px;"><use href="#icon-star"/></svg>Hanukkah (2nd day)</div>
              </div>
              <div class="event-item__time"><span class="event-item__time-start" style="color: var(--color-alert);">all-day</span></div>
            </div>
          </div>
        </div>
        <div class="event-list__section">
          <div class="event-list__date event-list__date--future">Wednesday, Dec 18</div>
          <div class="event-list__items">
            <div class="event-item">
              <div class="event-item__bar event-item__bar--purple"></div>
              <div class="event-item__content"><div class="event-item__title">Dentist Appointment</div></div>
              <div class="event-item__time">
                <span class="event-item__time-start">2:30PM</span>
                <span class="event-item__time-end">3:30PM</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Weather Widget -->
      <div class="widget" id="weather-widget">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 16px;">
            <svg class="icon icon--2xl" id="weather-icon"><use href="#weather-sun"/></svg>
            <div>
              <div class="weather__temp"><span id="weather-temp">--</span><span class="weather__temp-unit">°</span></div>
              <div class="weather__condition" id="weather-condition">Loading...</div>
            </div>
          </div>
          <div style="text-align: right;">
            <div class="weather__location" id="weather-location">Owens Cross Roads</div>
            <div class="weather__range"><span class="weather__range-high" id="weather-high">--°</span> / <span id="weather-low">--°</span></div>
            <div class="weather__feels-like">Feels like <span id="weather-feels">--</span>°</div>
          </div>
        </div>
        <div class="section">
          <div class="section__title">Conditions</div>
          <div class="weather__stats">
            <div class="weather__stat"><div class="weather__stat-value" id="weather-humidity">--%</div><div class="weather__stat-label">Humidity</div></div>
            <div class="weather__stat"><div class="weather__stat-value" id="weather-wind">-- mph</div><div class="weather__stat-label">Wind</div></div>
            <div class="weather__stat"><div class="weather__stat-value" id="weather-precip">--%</div><div class="weather__stat-label">Precip</div></div>
          </div>
        </div>
        <div class="section">
          <div class="section__title">This Week</div>
          <div class="weather__daily" id="weather-forecast"></div>
        </div>
      </div>

      <!-- Photo Frame -->
      <div class="photo-frame" style="height: 100%;">
        <img class="photo-frame__image" src="photo.jpeg" alt="Photo" style="object-fit: cover; object-position: center; height: 100%;"/>
      </div>

      <!-- Notes Widget (Large) -->
      <div class="widget" id="note-widget" style="display: flex; flex-direction: column; overflow: hidden;">
        <div class="note__header">
          <span class="note__title">Veggies</span>
          <button class="btn btn--icon" id="note-edit-btn"><svg class="icon icon--sm"><use href="#icon-edit"/></svg></button>
        </div>
        <div class="note__content" id="note-content" style="flex: 1; overflow-y: auto; min-height: 0;">Loading...</div>
        <div class="note__timestamp" id="note-timestamp"></div>
      </div>
    </div>

    <!-- Bottom row: Radar, Recipe, Light tiles -->
    <div class="bottom-row">
      <!-- Radar Frame -->
      <div class="radar-frame">
        <img src="https://radar.weather.gov/ridge/standard/KHTX_loop.gif" alt="Alabama Weather Radar"/>
      </div>

      <!-- Recipe Widget -->
      <div class="recipe" id="recipe-widget" style="height: 100%;">
        <img
          class="recipe__image"
          id="recipe-image"
          src="https://images.unsplash.com/photo-1546549032-9571cd6b27df?w=600&h=450&fit=crop"
          alt="Recipe"
          style="height: 100%; aspect-ratio: auto;"
        />
        <div class="recipe__overlay">
          <div class="recipe__source">
            <span class="recipe__source-logo">NYT</span> Cooking · Recipe of the Day
          </div>
          <h3 class="recipe__title" id="recipe-title">Loading...</h3>
          <div class="recipe__meta">
            <div class="recipe__meta-item" id="recipe-time">
              <svg class="icon icon--sm"><use href="#icon-clock"/></svg>
              <span>--</span>
            </div>
            <div class="recipe__meta-item" id="recipe-servings">
              <svg class="icon icon--sm"><use href="#icon-users"/></svg>
              <span>--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Stacked Light Tiles -->
      <div class="tile-stack">
        <div class="tile tile--on-standby">
          <div class="tile__icon"><svg class="icon"><use href="#icon-lightbulb"/></svg></div>
          <div class="tile__content">
            <div class="tile__name">Catchall Shutdown</div>
            <div class="tile__status">Off</div>
          </div>
        </div>
        <div class="tile tile--active">
          <div class="tile__icon"><svg class="icon"><use href="#icon-lightbulb"/></svg></div>
          <div class="tile__content">
            <div class="tile__name">Bright</div>
            <div class="tile__status">100%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Tile button behavior fixes */
    .tile[data-device] {
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      outline: none;
      transition: transform 0.1s ease, opacity 0.1s ease;
    }
    .tile[data-device]:active {
      transform: scale(0.96);
      opacity: 0.8;
    }
    .tile[data-device] * {
      pointer-events: none;
    }

    /* Recipe widget tap fix */
    #recipe-widget {
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      outline: none;
    }
    #recipe-widget * {
      pointer-events: none;
    }

    /* Brightness slider modal */
    .brightness-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .brightness-modal.active {
      display: flex;
    }
    .brightness-modal__content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .brightness-modal__name {
      font-size: 28px;
      font-weight: 500;
      color: #fff;
    }
    .brightness-modal__value {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.7);
    }
    .brightness-modal__slider-container {
      width: 100px;
      height: 320px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50px;
      position: relative;
      overflow: hidden;
      touch-action: none;
    }
    .brightness-modal__slider-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 50px;
      transition: height 0.05s ease;
    }
    .brightness-modal__slider-icon {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 32px;
      color: #8e8e93;
      z-index: 1;
    }
    .brightness-modal__slider-track {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2;
    }

    /* QR Code Modal */
    .qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .qr-modal.active {
      display: flex;
    }
    .qr-modal__content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      padding: 40px;
      background: #fff;
      border-radius: 24px;
      max-width: 400px;
    }
    .qr-modal__title {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
      text-align: center;
      line-height: 1.3;
    }
    .qr-modal__qr {
      width: 200px;
      height: 200px;
      background: #fff;
    }
    .qr-modal__hint {
      font-size: 16px;
      color: #666;
      text-align: center;
    }

    /* Note Edit Modal */
    .note-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .note-modal.active {
      display: flex;
    }
    .note-modal__content {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: 700px;
      max-width: 90%;
    }
    .note-modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .note-modal__title {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
    }
    .note-modal__close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    #note-editor {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
    }
    #note-editor .pell-content {
      height: 320px;
      overflow-y: auto;
      font-size: 16px;
      padding: 12px;
    }
    .pell-actionbar {
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      border-radius: 8px 8px 0 0;
    }
    .note-modal__save {
      margin-top: 16px;
      width: 100%;
      padding: 12px;
      background: #007aff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
    }
    .note-modal__save:active {
      background: #0056b3;
    }
  </style>

  <!-- Note Edit Modal -->
  <div class="note-modal" id="note-modal">
    <div class="note-modal__content">
      <div class="note-modal__header">
        <span class="note-modal__title">Edit Note</span>
        <button class="note-modal__close" id="note-close">&times;</button>
      </div>
      <textarea id="note-editor" style="width:100%; height:350px; font-size:16px; padding:12px; border:1px solid #ddd; border-radius:8px; resize:none;"></textarea>
      <button class="note-modal__save" id="note-save">Save</button>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div class="qr-modal" id="qr-modal">
    <div class="qr-modal__content">
      <div class="qr-modal__title" id="qr-modal-title">Recipe</div>
      <div class="qr-modal__qr" id="qr-code"></div>
      <div class="qr-modal__hint">Scan to open on your phone</div>
    </div>
  </div>

  <!-- Brightness Modal -->
  <div class="brightness-modal" id="brightness-modal">
    <div class="brightness-modal__content">
      <div class="brightness-modal__name" id="brightness-modal-name">Light</div>
      <div class="brightness-modal__value" id="brightness-modal-value">100%</div>
      <div class="brightness-modal__slider-container" id="brightness-slider">
        <div class="brightness-modal__slider-fill" id="brightness-fill"></div>
        <svg class="brightness-modal__slider-icon" viewBox="0 0 24 24">
          <path d="M12 2a7 7 0 0 0-7 7c0 2.54 1.4 4.75 3.47 5.9.17.1.28.27.33.46L9 17a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2l.2-1.64c.05-.19.16-.36.33-.46A7 7 0 0 0 12 2z" fill="currentColor"/>
          <path d="M9 21h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
        </svg>
        <div class="brightness-modal__slider-track" id="brightness-track"></div>
      </div>
    </div>
  </div>


  <script src="device-control.js"></script>
  <script>
    // Global config - loaded from config.json
    let CONFIG = null;

    async function loadConfig() {
      try {
        const response = await fetch('config.json');
        CONFIG = await response.json();

        // Apply config to UI
        if (CONFIG.home?.title) {
          document.getElementById('homeTitle').textContent = CONFIG.home.title;
        }
        if (CONFIG.weather?.location) {
          document.getElementById('weather-location').textContent = CONFIG.weather.location;
        }
      } catch (error) {
        console.error('Failed to load config.json:', error);
        // Use defaults
        CONFIG = {
          weather: { latitude: 34.67, longitude: -86.50, timezone: 'America/Chicago' },
          apis: { note: '', recipe: '' }
        };
      }
    }

    function getWeatherApiUrl() {
      const lat = CONFIG?.weather?.latitude || 34.67;
      const lon = CONFIG?.weather?.longitude || -86.50;
      const tz = CONFIG?.weather?.timezone || 'America/Chicago';
      return `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=${encodeURIComponent(tz)}&temperature_unit=fahrenheit&wind_speed_unit=mph&forecast_days=4`;
    }

    // Weather code to icon and description mapping
    const WEATHER_CODES = {
      0: { icon: 'weather-sun', desc: 'Clear' },
      1: { icon: 'weather-sun', desc: 'Mostly Clear' },
      2: { icon: 'weather-partly-cloudy', desc: 'Partly Cloudy' },
      3: { icon: 'weather-partly-cloudy', desc: 'Overcast' },
      45: { icon: 'weather-partly-cloudy', desc: 'Foggy' },
      48: { icon: 'weather-partly-cloudy', desc: 'Icy Fog' },
      51: { icon: 'weather-storm', desc: 'Light Drizzle' },
      53: { icon: 'weather-storm', desc: 'Drizzle' },
      55: { icon: 'weather-storm', desc: 'Heavy Drizzle' },
      61: { icon: 'weather-storm', desc: 'Light Rain' },
      63: { icon: 'weather-storm', desc: 'Rain' },
      65: { icon: 'weather-storm', desc: 'Heavy Rain' },
      71: { icon: 'weather-storm', desc: 'Light Snow' },
      73: { icon: 'weather-storm', desc: 'Snow' },
      75: { icon: 'weather-storm', desc: 'Heavy Snow' },
      77: { icon: 'weather-storm', desc: 'Snow Grains' },
      80: { icon: 'weather-storm', desc: 'Light Showers' },
      81: { icon: 'weather-storm', desc: 'Showers' },
      82: { icon: 'weather-storm', desc: 'Heavy Showers' },
      85: { icon: 'weather-storm', desc: 'Snow Showers' },
      86: { icon: 'weather-storm', desc: 'Heavy Snow Showers' },
      95: { icon: 'weather-storm', desc: 'Thunderstorm' },
      96: { icon: 'weather-storm', desc: 'Thunderstorm w/ Hail' },
      99: { icon: 'weather-storm', desc: 'Severe Thunderstorm' },
    };

    function getWeatherInfo(code) {
      return WEATHER_CODES[code] || { icon: 'weather-sun', desc: 'Unknown' };
    }

    function getDayName(dateStr, index) {
      if (index === 0) return 'Today';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'short' });
    }

    async function fetchWeather() {
      try {
        const response = await fetch(getWeatherApiUrl());
        if (!response.ok) throw new Error('Weather fetch failed');
        const data = await response.json();

        const current = data.current;
        const daily = data.daily;

        // Current conditions
        const weatherInfo = getWeatherInfo(current.weather_code);
        document.getElementById('weather-icon').innerHTML = `<use href="#${weatherInfo.icon}"/>`;
        document.getElementById('weather-temp').textContent = Math.round(current.temperature_2m);
        document.getElementById('weather-condition').textContent = weatherInfo.desc;
        document.getElementById('weather-feels').textContent = Math.round(current.apparent_temperature);
        document.getElementById('weather-humidity').textContent = current.relative_humidity_2m + '%';
        document.getElementById('weather-wind').textContent = Math.round(current.wind_speed_10m) + ' mph';
        document.getElementById('weather-precip').textContent = (daily.precipitation_probability_max[0] || 0) + '%';

        // Today's high/low
        document.getElementById('weather-high').textContent = Math.round(daily.temperature_2m_max[0]) + '°';
        document.getElementById('weather-low').textContent = Math.round(daily.temperature_2m_min[0]) + '°';

        // Calculate temp range for bar positioning
        const allTemps = [...daily.temperature_2m_max, ...daily.temperature_2m_min];
        const minTemp = Math.min(...allTemps);
        const maxTemp = Math.max(...allTemps);
        const tempRange = maxTemp - minTemp || 1;

        // Build forecast HTML
        let forecastHTML = '';
        for (let i = 0; i < 4; i++) {
          const dayInfo = getWeatherInfo(daily.weather_code[i]);
          const low = Math.round(daily.temperature_2m_min[i]);
          const high = Math.round(daily.temperature_2m_max[i]);
          const precip = daily.precipitation_probability_max[i] || 0;

          // Calculate bar position (0-100%)
          const barLeft = ((low - minTemp) / tempRange) * 100;
          const barWidth = ((high - low) / tempRange) * 100;

          forecastHTML += `
            <div class="weather__day ${i === 0 ? 'weather__day--today' : ''}">
              <span class="weather__day-name">${getDayName(daily.time[i], i)}</span>
              <svg style="width: 28px; height: 28px;"><use href="#${dayInfo.icon}"/></svg>
              <span class="weather__day-precip">${precip > 0 ? precip + '%' : ''}</span>
              <div class="weather__day-temps">
                <span class="weather__day-low">${low}°</span>
                <div class="weather__day-bar"><div class="weather__day-bar-fill" style="left: ${barLeft}%; width: ${barWidth}%;"></div></div>
                <span class="weather__day-high">${high}°</span>
              </div>
            </div>
          `;
        }
        document.getElementById('weather-forecast').innerHTML = forecastHTML;

      } catch (error) {
        console.error('Error fetching weather:', error);
        document.getElementById('weather-condition').textContent = 'Error loading';
      }
    }

    // Fetch weather on load and every 30 minutes
    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig();
      fetchWeather();
      setInterval(fetchWeather, 1800000);
    });
  </script>
  <script>
    function getNoteApiUrl() {
      return CONFIG?.apis?.note || '';
    }

    async function fetchNote() {
      const noteApi = getNoteApiUrl();
      if (!noteApi) return;
      try {
        const response = await fetch(noteApi);
        if (!response.ok) throw new Error('Failed to fetch note');
        const data = await response.json();

        document.getElementById('note-content').innerHTML = data.html || 'No content';
        document.getElementById('note-timestamp').textContent = 'Synced with Apple Notes';
      } catch (error) {
        console.error('Error fetching note:', error);
        document.getElementById('note-content').innerHTML = 'Unable to load note';
        document.getElementById('note-timestamp').textContent = 'Check Mac connection';
      }
    }

    async function saveNoteHtml(html) {
      const noteApi = getNoteApiUrl();
      if (!noteApi) return false;
      try {
        const response = await fetch(noteApi, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ html })
        });
        if (!response.ok) throw new Error('Failed to save note');
        await fetchNote();
        return true;
      } catch (error) {
        console.error('Error saving note:', error);
        return false;
      }
    }

    function openNoteModal() {
      const text = document.getElementById('note-content').innerText;
      document.getElementById('note-editor').value = text;
      document.getElementById('note-modal').classList.add('active');
    }

    function closeNoteModal() {
      document.getElementById('note-modal').classList.remove('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchNote();
      setInterval(fetchNote, 30000);

      document.getElementById('note-edit-btn').addEventListener('click', openNoteModal);
      document.getElementById('note-edit-btn').addEventListener('touchend', (e) => {
        e.preventDefault();
        openNoteModal();
      });

      document.getElementById('note-close').addEventListener('click', closeNoteModal);

      document.getElementById('note-save').addEventListener('click', async () => {
        const text = document.getElementById('note-editor').value;
        // Convert text to HTML, preserving lines
        const html = text.split('\n').map(line => '<div>' + (line || '<br>') + '</div>').join('');
        if (await saveNoteHtml(html)) {
          closeNoteModal();
        }
      });

      document.getElementById('note-modal').addEventListener('click', (e) => {
        if (e.target.id === 'note-modal') {
          closeNoteModal();
        }
      });
    });
  </script>
  <script>
    // Recipe state
    let currentRecipeUrl = 'https://cooking.nytimes.com';

    function getRecipeApiUrl() {
      return CONFIG?.apis?.recipe || '';
    }

    // Fetch and display recipe
    async function fetchRecipe() {
      const recipeApi = getRecipeApiUrl();
      if (!recipeApi) return;
      try {
        const response = await fetch(recipeApi);
        if (!response.ok) throw new Error('Failed to fetch recipe');
        const recipe = await response.json();

        currentRecipeUrl = recipe.url || 'https://cooking.nytimes.com';

        document.getElementById('recipe-title').textContent = recipe.title || 'Recipe of the Day';

        if (recipe.image) {
          document.getElementById('recipe-image').src = recipe.image;
        }

        const timeEl = document.getElementById('recipe-time').querySelector('span');
        const servingsEl = document.getElementById('recipe-servings').querySelector('span');

        timeEl.textContent = recipe.time || '--';
        servingsEl.textContent = recipe.servings ? `${recipe.servings} servings` : '--';

      } catch (error) {
        console.error('Error fetching recipe:', error);
      }
    }

    // Show QR code modal
    function showRecipeQR() {
      const modal = document.getElementById('qr-modal');
      const qrContainer = document.getElementById('qr-code');
      const title = document.getElementById('recipe-title').textContent;

      document.getElementById('qr-modal-title').textContent = title;

      // Use QR code API service
      const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(currentRecipeUrl);
      qrContainer.innerHTML = '<img src="' + qrUrl + '" alt="QR Code" style="width:200px;height:200px;">';

      modal.classList.add('active');
    }

    // Initialize recipe handlers
    document.addEventListener('DOMContentLoaded', () => {
      // Close QR modal
      document.getElementById('qr-modal').addEventListener('click', (e) => {
        if (e.target.id === 'qr-modal') {
          document.getElementById('qr-modal').classList.remove('active');
        }
      });

      // Recipe widget tap handler
      const recipeWidget = document.getElementById('recipe-widget');
      if (recipeWidget) {
        recipeWidget.addEventListener('touchend', (e) => {
          e.preventDefault();
          showRecipeQR();
        }, { passive: false });
        recipeWidget.addEventListener('click', () => {
          if (!('ontouchend' in window)) {
            showRecipeQR();
          }
        });
      }

      // Fetch recipe on load and every hour
      fetchRecipe();
      setInterval(fetchRecipe, 3600000);
    });
  </script>
  <script>
    // Brightness modal state
    let brightnessModalDevice = null;
    let longPressTimer = null;
    let isDragging = false;

    // Generate tiles from DEVICES config
    function renderDeviceTiles() {
      const container = document.getElementById('device-tiles');
      const devices = getDeviceConfig();

      container.innerHTML = '';

      for (const [deviceId, config] of Object.entries(devices)) {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.dataset.device = deviceId;
        tile.innerHTML = `
          <div class="tile__icon"><svg class="icon"><use href="#icon-${config.icon || 'lightbulb'}"/></svg></div>
          <div class="tile__content">
            <div class="tile__name">${config.name}</div>
            <div class="tile__status">Loading...</div>
          </div>
        `;

        // Long press for lights
        if (config.type === 'light') {
          tile.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
              longPressTimer = null;
              openBrightnessModal(deviceId);
            }, 500);
          }, { passive: true });

          tile.addEventListener('touchend', (e) => {
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
              e.preventDefault();
              toggle(deviceId);
            }
          }, { passive: false });

          tile.addEventListener('touchmove', () => {
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
          }, { passive: true });
        } else {
          // Regular tap for non-lights
          tile.addEventListener('touchend', (e) => {
            e.preventDefault();
            toggle(deviceId);
          }, { passive: false });
        }

        // Click fallback for non-touch
        tile.addEventListener('click', () => {
          if (!('ontouchend' in window)) {
            toggle(deviceId);
          }
        });

        container.appendChild(tile);
      }
    }

    // Brightness modal functions
    function openBrightnessModal(deviceId) {
      const state = getState(deviceId);
      const config = getDeviceConfig()[deviceId];
      if (!state || !config) return;

      brightnessModalDevice = deviceId;
      document.getElementById('brightness-modal-name').textContent = config.name;
      updateBrightnessDisplay(state.brightness || 100);
      document.getElementById('brightness-modal').classList.add('active');
    }

    function closeBrightnessModal() {
      document.getElementById('brightness-modal').classList.remove('active');
      brightnessModalDevice = null;
    }

    function updateBrightnessDisplay(value) {
      document.getElementById('brightness-modal-value').textContent = `${Math.round(value)}%`;
      document.getElementById('brightness-fill').style.height = `${value}%`;
    }

    // Slider interaction
    const slider = document.getElementById('brightness-slider');
    const track = document.getElementById('brightness-track');

    function handleSliderInteraction(e) {
      if (!brightnessModalDevice) return;

      const rect = slider.getBoundingClientRect();
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      const percent = Math.max(1, Math.min(100, 100 - (y / rect.height * 100)));

      updateBrightnessDisplay(percent);
      return percent;
    }

    track.addEventListener('touchstart', (e) => {
      isDragging = true;
      handleSliderInteraction(e);
    }, { passive: true });

    track.addEventListener('touchmove', (e) => {
      if (isDragging) {
        handleSliderInteraction(e);
      }
    }, { passive: true });

    track.addEventListener('touchend', (e) => {
      if (isDragging && brightnessModalDevice) {
        const rect = slider.getBoundingClientRect();
        const touch = e.changedTouches[0];
        const y = touch.clientY - rect.top;
        const percent = Math.max(1, Math.min(100, 100 - (y / rect.height * 100)));
        setBrightness(brightnessModalDevice, Math.round(percent));
      }
      isDragging = false;
    }, { passive: true });

    // Close modal on background tap
    document.getElementById('brightness-modal').addEventListener('click', (e) => {
      if (e.target.id === 'brightness-modal') {
        closeBrightnessModal();
      }
    });

    // Start when page loads
    document.addEventListener('DOMContentLoaded', () => {
      renderDeviceTiles();
      startPolling(10000, updateTileUI);
    });
  </script>
  <script>
    function updateDate() {
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      const dateStr = new Date().toLocaleDateString('en-US', options);
      document.getElementById('currentDate').textContent = dateStr;
    }
    updateDate();
    setInterval(updateDate, 3600000);
  </script>

</body>
</html>
